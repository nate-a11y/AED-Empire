{% comment %}
  Product Bundles Section - Pulls from Product Bundle metaobjects

  Metaobject Definition: Product Bundle
  Expected fields: title, description, products (list of product refs), savings, image, badge
{% endcomment %}

<section class="section bundle-section{% if section.settings.alt_bg %} section--alt{% endif %}">
  <div class="container">
    <div class="section-header">
      <h2>{{ section.settings.title | default: 'AED Packages & Bundles' }}</h2>
      {% if section.settings.subtitle != blank %}
        <p>{{ section.settings.subtitle }}</p>
      {% endif %}
      <div class="section-header__divider"></div>
    </div>

    {% assign bundle_handle = section.settings.metaobject_type | default: 'product_bundle' %}
    {% assign bundles = shop.metaobjects[bundle_handle].values %}

    {% if bundles.size > 0 %}
      <div class="bundle-section__grid">
        {% for bundle in bundles limit: section.settings.limit %}
          <article class="bundle-card">
            {% if bundle.badge != blank %}
              <span class="bundle-card__badge">{{ bundle.badge }}</span>
            {% endif %}

            {% if bundle.image != blank %}
              <div class="bundle-card__image">
                {{ bundle.image | image_url: width: 600 | image_tag: loading: 'lazy', alt: bundle.title }}
              </div>
            {% endif %}

            <div class="bundle-card__content">
              <h3 class="bundle-card__title">{{ bundle.title }}</h3>

              {% if bundle.description != blank %}
                <p class="bundle-card__description">{{ bundle.description | truncate: 150 }}</p>
              {% endif %}

              {% comment %} Bundle Products {% endcomment %}
              {% assign bundle_products = bundle.products.value %}
              {% if bundle_products.size > 0 %}
                <div class="bundle-card__products">
                  <h4>Includes:</h4>
                  <ul>
                    {% for prod in bundle_products limit: 5 %}
                      <li>
                        {% if prod.featured_image %}
                          <img src="{{ prod.featured_image | image_url: width: 60 }}" alt="" loading="lazy">
                        {% endif %}
                        <span>{{ prod.title | truncate: 40 }}</span>
                      </li>
                    {% endfor %}
                    {% if bundle_products.size > 5 %}
                      <li class="bundle-card__more">+{{ bundle_products.size | minus: 5 }} more items</li>
                    {% endif %}
                  </ul>
                </div>

                {% comment %} Calculate bundle price {% endcomment %}
                {% assign bundle_total = 0 %}
                {% for prod in bundle_products %}
                  {% assign bundle_total = bundle_total | plus: prod.price %}
                {% endfor %}

                <div class="bundle-card__pricing">
                  {% if bundle.price != blank %}
                    <span class="bundle-card__price">{{ bundle.price | money }}</span>
                    {% if bundle_total > 0 %}
                      <span class="bundle-card__compare">{{ bundle_total | money }}</span>
                      {% assign savings = bundle_total | minus: bundle.price %}
                      {% if savings > 0 %}
                        <span class="bundle-card__savings">Save {{ savings | money }}</span>
                      {% endif %}
                    {% endif %}
                  {% elsif bundle.savings != blank %}
                    <span class="bundle-card__savings-text">{{ bundle.savings }}</span>
                  {% endif %}
                </div>
              {% endif %}

              <div class="bundle-card__actions">
                {% if bundle.link != blank %}
                  <a href="{{ bundle.link }}" class="btn btn--primary">View Bundle</a>
                {% elsif bundle_products.size > 0 and bundle_products.first %}
                  <a href="{{ bundle_products.first.url }}" class="btn btn--primary">View Bundle</a>
                {% endif %}
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="bundle-section__empty">No bundles available.</p>
    {% endif %}
  </div>
</section>

<style>
.bundle-section__grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 30px;
}
.bundle-card {
  position: relative;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}
.bundle-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}
.bundle-card__badge {
  position: absolute;
  top: 15px;
  left: 15px;
  background: var(--color-primary);
  color: #fff;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  z-index: 2;
}
.bundle-card__image {
  aspect-ratio: 16/10;
  overflow: hidden;
  background: var(--color-bg-alt);
}
.bundle-card__image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.bundle-card__content {
  padding: 25px;
}
.bundle-card__title {
  font-size: 1.25rem;
  margin: 0 0 10px;
}
.bundle-card__description {
  font-size: 0.9375rem;
  color: var(--color-text-light);
  line-height: 1.6;
  margin: 0 0 20px;
}
.bundle-card__products h4 {
  font-size: 0.8125rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--color-text-light);
  margin: 0 0 10px;
}
.bundle-card__products ul {
  list-style: none;
  padding: 0;
  margin: 0 0 20px;
}
.bundle-card__products li {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--color-border);
  font-size: 0.875rem;
}
.bundle-card__products li:last-child {
  border-bottom: none;
}
.bundle-card__products img {
  width: 40px;
  height: 40px;
  object-fit: contain;
  border-radius: 4px;
  background: var(--color-bg-alt);
}
.bundle-card__more {
  color: var(--color-text-light);
  font-style: italic;
}
.bundle-card__pricing {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}
.bundle-card__price {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-heading);
}
.bundle-card__compare {
  font-size: 1rem;
  color: var(--color-text-light);
  text-decoration: line-through;
}
.bundle-card__savings {
  background: #dcfce7;
  color: #166534;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 0.8125rem;
  font-weight: 600;
}
.bundle-card__savings-text {
  color: var(--color-success);
  font-weight: 600;
}
.bundle-card__actions {
  margin-top: auto;
}
.bundle-card__actions .btn {
  width: 100%;
}
.bundle-section__empty {
  text-align: center;
  color: var(--color-text-light);
}
</style>

{% schema %}
{
  "name": "Bundles (Metaobjects)",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "AED Packages & Bundles"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Save more with our curated AED packages"
    },
    {
      "type": "text",
      "id": "metaobject_type",
      "label": "Metaobject handle",
      "default": "product_bundle",
      "info": "The handle of your Product Bundle metaobject definition"
    },
    {
      "type": "number",
      "id": "limit",
      "label": "Maximum bundles to show",
      "default": 6
    },
    {
      "type": "checkbox",
      "id": "alt_bg",
      "label": "Alternate background",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Bundles (Metaobjects)"
    }
  ]
}
{% endschema %}

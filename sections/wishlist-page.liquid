{% comment %}
  Wishlist Page Section
  Premium feature - full wishlist with share functionality
{% endcomment %}

<section class="wishlist-page section" aria-labelledby="wishlist-heading">
  <div class="container">
    <div class="wishlist-page__header">
      <h1 id="wishlist-heading">{{ section.settings.title | default: 'My Wishlist' }}</h1>
      <p class="wishlist-page__count" data-wishlist-page-count>0 items saved</p>
    </div>

    {%- comment -%} Empty State {%- endcomment -%}
    <div class="wishlist-page__empty" data-wishlist-empty>
      <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" aria-hidden="true">
        <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
      </svg>
      <h2>Your wishlist is empty</h2>
      <p>Save items you love by clicking the heart icon on any product.</p>
      <a href="/collections/all" class="btn btn--primary">Start Shopping</a>
    </div>

    {%- comment -%} Wishlist Grid {%- endcomment -%}
    <div class="wishlist-page__grid" data-wishlist-grid hidden>
      {%- comment -%} Products injected by JS {%- endcomment -%}
    </div>

    {%- comment -%} Actions {%- endcomment -%}
    <div class="wishlist-page__actions" data-wishlist-actions hidden>
      <button type="button" class="btn btn--primary" data-wishlist-add-all>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
        Add All to Cart
      </button>
      <button type="button" class="btn btn--outline" data-wishlist-share>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Share Wishlist
      </button>
      <button type="button" class="btn btn--outline" data-wishlist-clear>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
        Clear Wishlist
      </button>
    </div>
  </div>
</section>

{%- comment -%} Share Modal {%- endcomment -%}
<div class="wishlist-share-modal" data-wishlist-share-modal hidden role="dialog" aria-modal="true" aria-labelledby="share-modal-title">
  <div class="wishlist-share-modal__overlay" data-wishlist-share-close></div>
  <div class="wishlist-share-modal__content">
    <button type="button" class="wishlist-share-modal__close" data-wishlist-share-close aria-label="Close">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <h3 id="share-modal-title">Share Your Wishlist</h3>
    <div class="wishlist-share-modal__options">
      <a href="#" class="wishlist-share-modal__option" data-share-email>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Email
      </a>
      <button type="button" class="wishlist-share-modal__option" data-share-copy>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Copy Link
      </button>
    </div>
    <div class="wishlist-share-modal__copied" hidden>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
      Link copied to clipboard!
    </div>
  </div>
</div>

<script>
  (function() {
    const STORAGE_KEY = 'aed_wishlist';
    const grid = document.querySelector('[data-wishlist-grid]');
    const empty = document.querySelector('[data-wishlist-empty]');
    const actions = document.querySelector('[data-wishlist-actions]');
    const countEl = document.querySelector('[data-wishlist-page-count]');
    const shareModal = document.querySelector('[data-wishlist-share-modal]');

    function getWishlist() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        return [];
      }
    }

    function saveWishlist(list) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        window.dispatchEvent(new CustomEvent('wishlist:updated', { detail: { count: list.length } }));
      } catch {}
    }

    function renderWishlist() {
      const list = getWishlist();

      if (countEl) {
        countEl.textContent = `${list.length} item${list.length !== 1 ? 's' : ''} saved`;
      }

      if (list.length === 0) {
        if (empty) empty.hidden = false;
        if (grid) grid.hidden = true;
        if (actions) actions.hidden = true;
        return;
      }

      if (empty) empty.hidden = true;
      if (grid) grid.hidden = false;
      if (actions) actions.hidden = false;

      if (grid) {
        grid.innerHTML = list.map(p => `
          <div class="wishlist-item" data-wishlist-item="${p.handle}">
            <button type="button" class="wishlist-item__remove" data-wishlist-remove="${p.handle}" aria-label="Remove ${p.title}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <a href="${p.url}" class="wishlist-item__image">
              <img src="${p.image}" alt="${p.title}" width="200" height="200" loading="lazy">
            </a>
            <div class="wishlist-item__info">
              <h3 class="wishlist-item__title"><a href="${p.url}">${p.title}</a></h3>
              <p class="wishlist-item__price">${window.themeUtils ? window.themeUtils.formatMoney(p.price) : '$' + (p.price / 100).toFixed(2)}</p>
              ${p.available
                ? `<button type="button" class="btn btn--primary btn--small btn--full" data-wishlist-add-cart="${p.handle}">Add to Cart</button>`
                : '<button class="btn btn--outline btn--small btn--full" disabled>Sold Out</button>'
              }
            </div>
          </div>
        `).join('');
      }
    }

    // Remove item
    document.addEventListener('click', async e => {
      const removeBtn = e.target.closest('[data-wishlist-remove]');
      if (removeBtn) {
        const handle = removeBtn.dataset.wishlistRemove;
        let list = getWishlist();
        list = list.filter(p => p.handle !== handle);
        saveWishlist(list);
        renderWishlist();
        window.updateWishlistButtons?.();
      }

      // Add to cart from wishlist
      const addBtn = e.target.closest('[data-wishlist-add-cart]');
      if (addBtn) {
        const handle = addBtn.dataset.wishlistAddCart;
        const list = getWishlist();
        const product = list.find(p => p.handle === handle);
        if (product) {
          try {
            const res = await fetch(`/products/${handle}.js`);
            const data = await res.json();
            await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ items: [{ id: data.variants[0].id, quantity: 1 }] })
            });
            document.dispatchEvent(new CustomEvent('cart:updated'));
            addBtn.textContent = 'Added!';
            setTimeout(() => { addBtn.textContent = 'Add to Cart'; }, 2000);
          } catch (err) {
            console.error(err);
          }
        }
      }
    });

    // Add all to cart
    document.querySelector('[data-wishlist-add-all]')?.addEventListener('click', async () => {
      const list = getWishlist().filter(p => p.available);
      const btn = document.querySelector('[data-wishlist-add-all]');
      btn.disabled = true;
      btn.textContent = 'Adding...';

      for (const p of list) {
        try {
          const res = await fetch(`/products/${p.handle}.js`);
          const data = await res.json();
          await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: [{ id: data.variants[0].id, quantity: 1 }] })
          });
        } catch {}
      }

      document.dispatchEvent(new CustomEvent('cart:updated'));
      btn.textContent = 'Added All!';
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg> Add All to Cart';
      }, 2000);
    });

    // Clear wishlist
    document.querySelector('[data-wishlist-clear]')?.addEventListener('click', () => {
      if (confirm('Clear all items from your wishlist?')) {
        saveWishlist([]);
        renderWishlist();
        window.updateWishlistButtons?.();
      }
    });

    // Share wishlist
    document.querySelector('[data-wishlist-share]')?.addEventListener('click', () => {
      if (shareModal) shareModal.hidden = false;
    });

    document.querySelectorAll('[data-wishlist-share-close]').forEach(el => {
      el.addEventListener('click', () => {
        if (shareModal) shareModal.hidden = true;
      });
    });

    document.querySelector('[data-share-copy]')?.addEventListener('click', () => {
      const list = getWishlist();
      const handles = list.map(p => p.handle).join(',');
      const url = `${window.location.origin}/pages/wishlist?items=${handles}`;
      navigator.clipboard.writeText(url).then(() => {
        const copied = shareModal.querySelector('.wishlist-share-modal__copied');
        if (copied) copied.hidden = false;
        setTimeout(() => { if (copied) copied.hidden = true; }, 3000);
      });
    });

    // Email share
    document.querySelector('[data-share-email]')?.addEventListener('click', e => {
      e.preventDefault();
      const list = getWishlist();
      const handles = list.map(p => p.handle).join(',');
      const url = `${window.location.origin}/pages/wishlist?items=${handles}`;
      const subject = encodeURIComponent('Check out my wishlist');
      const body = encodeURIComponent(`Here are some products I'm interested in:\n\n${url}`);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    // Load shared wishlist from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sharedItems = urlParams.get('items');
    if (sharedItems) {
      // Could implement loading shared wishlist here
    }

    renderWishlist();
  })();
</script>

{% schema %}
{
  "name": "Wishlist Page",
  "tag": "section",
  "class": "section-wishlist-page",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "My Wishlist"
    }
  ],
  "presets": [
    {
      "name": "Wishlist Page"
    }
  ]
}
{% endschema %}

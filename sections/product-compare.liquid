{% comment %}
  Enhanced Product Comparison Tool - Pulls ALL Metaobject Data
  Compares: specs, warranty, features, lifecycle, everything!
{% endcomment %}

<section class="product-compare section" id="product-compare" aria-labelledby="compare-heading">
  <div class="container">
    <div class="section-header">
      <h2 id="compare-heading">{{ section.settings.title | default: 'Compare Products' }}</h2>
      {% if section.settings.subtitle %}
        <p>{{ section.settings.subtitle }}</p>
      {% endif %}
    </div>

    {%- comment -%} Empty State {%- endcomment -%}
    <div class="product-compare__empty" data-compare-empty>
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
      </svg>
      <h3>No products to compare</h3>
      <p>Add products to compare by clicking the compare button on product cards.</p>
      <a href="/collections/all" class="btn btn--primary">Browse Products</a>
    </div>

    {%- comment -%} Comparison Table {%- endcomment -%}
    <div class="product-compare__table-wrapper" data-compare-table hidden>
      <div class="product-compare__actions">
        <button type="button" class="btn btn--outline btn--small" data-compare-clear>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          Clear All
        </button>
        <button type="button" class="btn btn--outline btn--small" data-compare-print>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Print Comparison
        </button>
      </div>

      <div class="product-compare__scroll">
        <table class="product-compare__table" role="table" aria-label="Product comparison">
          <thead>
            <tr>
              <th scope="col" class="product-compare__feature-header">Feature</th>
              {%- comment -%} Product headers injected by JS {%- endcomment -%}
            </tr>
          </thead>
          <tbody data-compare-body>
            {%- comment -%} Rows injected by JS {%- endcomment -%}
          </tbody>
          <tfoot>
            <tr>
              <td></td>
              {%- comment -%} Add to cart buttons injected by JS {%- endcomment -%}
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>

{%- comment -%} Floating Compare Bar {%- endcomment -%}
<div class="compare-bar" data-compare-bar hidden aria-live="polite">
  <div class="container">
    <div class="compare-bar__inner">
      <div class="compare-bar__products" data-compare-bar-products>
        {%- comment -%} Product thumbnails injected by JS {%- endcomment -%}
      </div>
      <div class="compare-bar__actions">
        <span class="compare-bar__count"><span data-compare-count>0</span> products selected</span>
        <a href="/pages/compare" class="btn btn--primary btn--small" data-compare-view">
          Compare Now
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const STORAGE_KEY = 'aed_compare_products';
    const MAX_COMPARE = {{ section.settings.max_products | default: 4 }};

    const compareBar = document.querySelector('[data-compare-bar]');
    const compareTable = document.querySelector('[data-compare-table]');
    const compareEmpty = document.querySelector('[data-compare-empty]');
    const compareBody = document.querySelector('[data-compare-body]');
    const compareCount = document.querySelector('[data-compare-count]');
    const compareBarProducts = document.querySelector('[data-compare-bar-products]');

    // COMPREHENSIVE COMPARISON FEATURES - ALL METAOBJECT DATA
    const compareFeatures = [
      // BASIC INFO
      { section: 'Basic Information', rows: [
        { key: 'price', label: 'Price', format: 'money' },
        { key: 'vendor', label: 'Manufacturer' },
        { key: 'shock_type', label: 'Shock Type', path: 'custom.shock_type' },
        { key: 'available', label: 'Availability', format: v => v ? '✓ In Stock' : '✗ Out of Stock' }
      ]},
      
      // KEY FEATURES
      { section: 'Key Features', rows: [
        { key: 'has_cpr_feedback', label: 'CPR Feedback', path: 'custom.has_cpr_feedback', format: v => v ? '<span style="color:#22c55e;font-size:20px">✓</span>' : '<span style="color:#ef4444;font-size:20px">✗</span>' },
        { key: 'has_wifi_monitoring', label: 'WiFi Monitoring', path: 'custom.has_wifi_monitoring', format: v => v ? '<span style="color:#22c55e;font-size:20px">✓</span>' : '<span style="color:#ef4444;font-size:20px">✗</span>' },
        { key: 'has_pediatric_mode', label: 'Pediatric Mode', path: 'custom.has_pediatric_mode', format: v => v ? '<span style="color:#22c55e;font-size:20px">✓</span>' : '<span style="color:#ef4444;font-size:20px">✗</span>' }
      ]},
      
      // TECHNICAL SPECS
      { section: 'Technical Specifications', rows: [
        { key: 'weight', label: 'Weight', path: 'custom.specifications.weight' },
        { key: 'dimensions', label: 'Dimensions', path: 'custom.specifications.dimensions' },
        { key: 'ip_rating', label: 'IP Rating', path: 'custom.specifications.ip_rating' },
        { key: 'shock_energy', label: 'Shock Energy', path: 'custom.specifications.shock_energy' },
        { key: 'analysis_time', label: 'Analysis Time', path: 'custom.specifications.analysis_time' },
        { key: 'charge_time', label: 'Charge Time', path: 'custom.specifications.charge_time' },
        { key: 'operating_temp', label: 'Operating Temperature', path: 'custom.specifications.operating_temp' }
      ]},
      
      // WARRANTY & LIFECYCLE
      { section: 'Warranty & Lifecycle', rows: [
        { key: 'warranty_years', label: 'Warranty Period', path: 'custom.warranty_years', format: v => v ? `${v} years` : '-' },
        { key: 'battery_life_years', label: 'Battery Life', path: 'custom.battery_life_years', format: v => v ? `${v} years` : '-' },
        { key: 'pad_life_years', label: 'Pad Life', path: 'custom.pad_life_years', format: v => v ? `${v} years` : '-' }
      ]}
    ];

    // Get compare list from storage
    function getCompareList() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        return []
      }
    }

    // Save compare list
    function saveCompareList(list) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      } catch {}
    }

    // Fetch product with ALL metafields via Storefront API
    async function fetchProductWithMetafields(handle) {
      const query = `
        query getProduct($handle: String!) {
          product(handle: $handle) {
            id
            handle
            title
            description
            featuredImage {
              url
            }
            priceRange {
              minVariantPrice {
                amount
                currencyCode
              }
            }
            compareAtPriceRange {
              minVariantPrice {
                amount
              }
            }
            availableForSale
            vendor
            productType
            variants(first: 1) {
              nodes {
                id
              }
            }
            manufacturer: metafield(namespace: "custom", key: "manufacturer") {
              value
            }
            shockType: metafield(namespace: "custom", key: "shock_type") {
              value
            }
            hasCprFeedback: metafield(namespace: "custom", key: "has_cpr_feedback") {
              value
            }
            hasWifiMonitoring: metafield(namespace: "custom", key: "has_wifi_monitoring") {
              value
            }
            hasPediatricMode: metafield(namespace: "custom", key: "has_pediatric_mode") {
              value
            }
            warrantyYears: metafield(namespace: "custom", key: "warranty_years") {
              value
            }
            batteryLifeYears: metafield(namespace: "custom", key: "battery_life_years") {
              value
            }
            padLifeYears: metafield(namespace: "custom", key: "pad_life_years") {
              value
            }
            specifications: metafield(namespace: "custom", key: "specifications") {
              reference {
                ... on Metaobject {
                  weight: field(key: "weight") { value }
                  dimensions: field(key: "dimensions") { value }
                  ipRating: field(key: "ip_rating") { value }
                  shockEnergy: field(key: "shock_energy") { value }
                  analysisTime: field(key: "analysis_time") { value }
                  chargeTime: field(key: "charge_time") { value }
                  operatingTemp: field(key: "operating_temp") { value }
                }
              }
            }
          }
        }
      `;

      const response = await fetch('/api/2024-10/graphql.json', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Shopify-Storefront-Access-Token': '{{ shop.metafields.custom.storefront_access_token | default: "e82db003ac36f1898e52adae1c8c4eaf" }}'
        },
        body: JSON.stringify({
          query: query,
          variables: { handle: handle }
        })
      });

      const result = await response.json();
      const product = result.data.product;

      // Transform to our format
      return {
        handle: product.handle,
        id: product.id,
        title: product.title,
        price: parseFloat(product.priceRange.minVariantPrice.amount) * 100, // Convert to cents
        compare_at_price: product.compareAtPriceRange?.minVariantPrice?.amount ? parseFloat(product.compareAtPriceRange.minVariantPrice.amount) * 100 : null,
        vendor: product.manufacturer?.value || product.vendor,
        type: product.productType,
        image: product.featuredImage?.url,
        url: `/products/${product.handle}`,
        available: product.availableForSale,
        variantId: product.variants.nodes[0]?.id,
        description: product.description?.replace(/<[^>]*>/g, '').substring(0, 150) + '...',
        
        // Metafields
        custom: {
          shock_type: product.shockType?.value,
          has_cpr_feedback: product.hasCprFeedback?.value === 'true',
          has_wifi_monitoring: product.hasWifiMonitoring?.value === 'true',
          has_pediatric_mode: product.hasPediatricMode?.value === 'true',
          warranty_years: product.warrantyYears?.value ? parseInt(product.warrantyYears.value) : null,
          battery_life_years: product.batteryLifeYears?.value ? parseInt(product.batteryLifeYears.value) : null,
          pad_life_years: product.padLifeYears?.value ? parseInt(product.padLifeYears.value) : null,
          specifications: product.specifications?.reference ? {
            weight: product.specifications.reference.weight?.value,
            dimensions: product.specifications.reference.dimensions?.value,
            ip_rating: product.specifications.reference.ipRating?.value,
            shock_energy: product.specifications.reference.shockEnergy?.value,
            analysis_time: product.specifications.reference.analysisTime?.value,
            charge_time: product.specifications.reference.chargeTime?.value,
            operating_temp: product.specifications.reference.operatingTemp?.value
          } : {}
        }
      };
    }

    // Get nested value from object
    function getNestedValue(obj, path) {
      return path.split('.').reduce((current, key) => current?.[key], obj);
    }

    // Add product to compare
    window.addToCompare = async function(handle) {
      const list = getCompareList();
      if (list.find(p => p.handle === handle)) {
        window.removeFromCompare(handle);
        return;
      }
      if (list.length >= MAX_COMPARE) {
        alert(`Maximum ${MAX_COMPARE} products can be compared`);
        return;
      }

      try {
        const product = await fetchProductWithMetafields(handle);
        list.push(product);
        saveCompareList(list);
        updateCompareUI();
        updateCompareButtons();
      } catch (err) {
        console.error('Error adding to compare:', err);
        alert('Error adding product to comparison');
      }
    };

    // Remove product from compare
    window.removeFromCompare = function(handle) {
      let list = getCompareList();
      list = list.filter(p => p.handle !== handle);
      saveCompareList(list);
      updateCompareUI();
      updateCompareButtons();
    };

    // Check if product is in compare
    window.isInCompare = function(handle) {
      return getCompareList().some(p => p.handle === handle);
    };

    // Update compare buttons on page
    function updateCompareButtons() {
      document.querySelectorAll('[data-compare-add]').forEach(btn => {
        const handle = btn.dataset.compareAdd;
        const isInList = window.isInCompare(handle);
        btn.classList.toggle('is-active', isInList);
        btn.setAttribute('aria-pressed', isInList);
        const textEl = btn.querySelector('.compare-btn__text');
        if (textEl) textEl.textContent = isInList ? 'Remove' : 'Compare';
      });
    }

    // Update floating bar and table
    function updateCompareUI() {
      const list = getCompareList();

      // Update count
      if (compareCount) {
        compareCount.textContent = list.length;
      }

      // Show/hide bar
      if (compareBar) {
        compareBar.hidden = list.length === 0;
      }

      // Update bar thumbnails
      if (compareBarProducts) {
        compareBarProducts.innerHTML = list.map(p => `
          <div class="compare-bar__product">
            <img src="${p.image}" alt="${p.title}" width="40" height="40">
            <button type="button" class="compare-bar__remove" onclick="removeFromCompare('${p.handle}')" aria-label="Remove ${p.title}">×</button>
          </div>
        `).join('');
      }

      // Update table
      if (compareTable && compareEmpty && compareBody) {
        if (list.length < 2) {
          compareTable.hidden = true;
          compareEmpty.hidden = false;
          return;
        }

        compareTable.hidden = false;
        compareEmpty.hidden = true;

        // Build header row
        const thead = compareTable.querySelector('thead tr');
        thead.innerHTML = '<th scope="col" class="product-compare__feature-header">Feature</th>';
        list.forEach(p => {
          thead.innerHTML += `
            <th scope="col" class="product-compare__product-header">
              <button type="button" class="product-compare__remove" onclick="removeFromCompare('${p.handle}')" aria-label="Remove ${p.title}">×</button>
              <a href="${p.url}">
                <img src="${p.image}" alt="${p.title}" width="120" height="120">
              </a>
              <a href="${p.url}" class="product-compare__product-title">${p.title}</a>
            </th>
          `;
        });

        // Build body rows WITH ALL METAOBJECT DATA
        compareBody.innerHTML = '';

        compareFeatures.forEach(featureGroup => {
          // Add section header
          const sectionRow = document.createElement('tr');
          sectionRow.className = 'product-compare__section-header';
          sectionRow.innerHTML = `<th colspan="${list.length + 1}" style="background:#f5f5f5;padding:12px 20px;font-weight:700;color:#8b1538;">${featureGroup.section}</th>`;
          compareBody.appendChild(sectionRow);

          // Add feature rows
          featureGroup.rows.forEach(feature => {
            const row = document.createElement('tr');
            row.innerHTML = `<th scope="row">${feature.label}</th>` + list.map(p => {
              let value;
              
              if (feature.path) {
                value = getNestedValue(p, feature.path);
              } else {
                value = p[feature.key];
              }

              if (feature.format) {
                if (feature.format === 'money') {
                  value = window.Shopify?.formatMoney ? window.Shopify.formatMoney(value, window.theme.moneyFormat) : '$' + (value / 100).toFixed(2);
                  if (p.compare_at_price > p.price) {
                    const compare = window.Shopify?.formatMoney ? window.Shopify.formatMoney(p.compare_at_price, window.theme.moneyFormat) : '$' + (p.compare_at_price / 100).toFixed(2);
                    value = `<strong>${value}</strong><br><span style="text-decoration:line-through;color:#999;font-size:0.9em">${compare}</span>`;
                  } else {
                    value = `<strong>${value}</strong>`;
                  }
                } else {
                  value = feature.format(value);
                }
              }

              return `<td>${value || '-'}</td>`;
            }).join('');
            compareBody.appendChild(row);
          });
        });

        // Build footer with add to cart buttons
        const tfoot = compareTable.querySelector('tfoot tr');
        tfoot.innerHTML = '<td></td>' + list.map(p => `
          <td>
            ${p.available
              ? `<a href="${p.url}" class="btn btn--primary btn--small btn--full">View Product</a>`
              : '<button class="btn btn--outline btn--small btn--full" disabled>Sold Out</button>'
            }
          </td>
        `).join('');
      }
    }

    // Clear all
    document.querySelector('[data-compare-clear]')?.addEventListener('click', () => {
      if (confirm('Clear all products from comparison?')) {
        saveCompareList([]);
        updateCompareUI();
        updateCompareButtons();
      }
    });

    // Print
    document.querySelector('[data-compare-print]')?.addEventListener('click', () => {
      window.print();
    });

    // Initialize
    updateCompareUI();
    updateCompareButtons();

    // Update buttons when products are added/removed
    document.addEventListener('compare:updated', updateCompareButtons);
  })();
</script>

{% schema %}
{
  "name": "Product Compare",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Compare Products"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum products to compare",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    }
  ],
  "presets": [
    {
      "name": "Product Compare"
    }
  ]
}
{% endschema %}

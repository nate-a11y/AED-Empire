{% comment %}
  Enhanced Product Comparison - Fixed Boolean and Metaobject Parsing
{% endcomment %}

<section class="product-compare section" id="product-compare" aria-labelledby="compare-heading">
  <div class="container">
    <div class="section-header">
      <h2 id="compare-heading">{{ section.settings.title | default: 'Compare Products' }}</h2>
      {% if section.settings.subtitle %}
        <p>{{ section.settings.subtitle }}</p>
      {% endif %}
    </div>

    <div class="product-compare__empty" data-compare-empty>
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
      </svg>
      <h3>No products to compare</h3>
      <p>Add products to compare by clicking the compare button on product cards.</p>
      <a href="/collections/all" class="btn btn--primary">Browse Products</a>
    </div>

    <div class="product-compare__table-wrapper" data-compare-table hidden>
      <div class="product-compare__actions">
        <button type="button" class="btn btn--outline btn--small" data-compare-clear>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          Clear All
        </button>
        <button type="button" class="btn btn--outline btn--small" data-compare-print>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Print Comparison
        </button>
      </div>

      <div class="product-compare__scroll">
        <table class="product-compare__table" role="table" aria-label="Product comparison">
          <thead>
            <tr>
              <th scope="col" class="product-compare__feature-header">Feature</th>
            </tr>
          </thead>
          <tbody data-compare-body></tbody>
          <tfoot>
            <tr>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>

<div class="compare-bar" data-compare-bar hidden aria-live="polite">
  <div class="container">
    <div class="compare-bar__inner">
      <div class="compare-bar__products" data-compare-bar-products"></div>
      <div class="compare-bar__actions">
        <span class="compare-bar__count"><span data-compare-count">0</span> products selected</span>
        <a href="/pages/compare" class="btn btn--primary btn--small" data-compare-view>Compare Now</a>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const STORAGE_KEY = 'aed_compare_products';
    const MAX_COMPARE = {{ section.settings.max_products | default: 4 }};

    const compareBar = document.querySelector('[data-compare-bar]');
    const compareTable = document.querySelector('[data-compare-table]');
    const compareEmpty = document.querySelector('[data-compare-empty]');
    const compareBody = document.querySelector('[data-compare-body]');
    const compareCount = document.querySelector('[data-compare-count]');
    const compareBarProducts = document.querySelector('[data-compare-bar-products]');

    // Helper function to parse boolean from any format
    function parseBoolean(value) {
      if (value === null || value === undefined) return false;
      if (typeof value === 'boolean') return value;
      if (typeof value === 'string') {
        return value.toLowerCase() === 'true' || value === '1';
      }
      return Boolean(value);
    }

    const compareFeatures = [
      { section: 'Basic Information', rows: [
        { key: 'price', label: 'Price', format: 'money' },
        { key: 'manufacturer', label: 'Manufacturer' },
        { key: 'shock_type', label: 'Shock Type' },
        { key: 'available', label: 'Availability', format: v => v ? '<span style="color:#22c55e">âœ“ In Stock</span>' : '<span style="color:#ef4444">âœ— Out of Stock</span>' }
      ]},
      
      { section: 'Key Features', rows: [
        { key: 'has_cpr_feedback', label: 'CPR Feedback', format: v => v ? '<span style="color:#22c55e;font-size:20px">âœ“</span>' : '<span style="color:#ef4444;font-size:20px">âœ—</span>' },
        { key: 'has_wifi_monitoring', label: 'WiFi Monitoring', format: v => v ? '<span style="color:#22c55e;font-size:20px">âœ“</span>' : '<span style="color:#ef4444;font-size:20px">âœ—</span>' },
        { key: 'has_pediatric_mode', label: 'Pediatric Mode', format: v => v ? '<span style="color:#22c55e;font-size:20px">âœ“</span>' : '<span style="color:#ef4444;font-size:20px">âœ—</span>' }
      ]},
      
      { section: 'Technical Specifications', rows: [
        { key: 'weight', label: 'Weight' },
        { key: 'dimensions', label: 'Dimensions' },
        { key: 'ip_rating', label: 'IP Rating' },
        { key: 'shock_delivery_type', label: 'Shock Delivery' },
        { key: 'cpr_feedback', label: 'CPR Feedback Details' },
        { key: 'pediatric_capability', label: 'Pediatric Capability' },
        { key: 'connectivity', label: 'Connectivity' }
      ]},
      
      { section: 'Warranty & Lifecycle', rows: [
        { key: 'warranty_years', label: 'Warranty Period', format: v => v ? `${v} years` : '-' },
        { key: 'battery_life_years', label: 'Battery Life', format: v => v ? `${v} years` : '-' },
        { key: 'pad_life_years', label: 'Pad Life', format: v => v ? `${v} years` : '-' }
      ]}
    ];

    function getCompareList() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        return [];
      }
    }

    function saveCompareList(list) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      } catch {}
    }

    async function fetchProductWithMetafields(handle) {
      console.log(`ðŸ” Fetching product: ${handle}`);
      
      const query = `
        query getProduct($handle: String!) {
          product(handle: $handle) {
            id
            handle
            title
            description
            featuredImage {
              url(transform: {maxWidth: 300})
            }
            priceRange {
              minVariantPrice {
                amount
                currencyCode
              }
            }
            compareAtPriceRange {
              minVariantPrice {
                amount
              }
            }
            availableForSale
            vendor
            productType
            variants(first: 1) {
              nodes {
                id
              }
            }
            metafields(identifiers: [
              {namespace: "custom", key: "manufacturer"},
              {namespace: "custom", key: "shock_type"},
              {namespace: "custom", key: "has_cpr_feedback"},
              {namespace: "custom", key: "has_wifi_monitoring"},
              {namespace: "custom", key: "has_pediatric_mode"},
              {namespace: "custom", key: "warranty_years"},
              {namespace: "custom", key: "battery_life_years"},
              {namespace: "custom", key: "pad_life_years"},
              {namespace: "custom", key: "specifications"}
            ]) {
              namespace
              key
              value
              type
              reference {
                ... on Metaobject {
                  fields {
                    key
                    value
                  }
                }
              }
            }
          }
        }
      `;

      try {
        const response = await fetch('https://{{ shop.permanent_domain }}/api/2024-10/graphql.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Shopify-Storefront-Access-Token': 'bbdd07adaf083ca9ff43460f2a37ea75'
          },
          body: JSON.stringify({
            query: query,
            variables: { handle: handle }
          })
        });

        const result = await response.json();
        
        console.log(`ðŸ“¦ API Response for ${handle}:`, result);
        
        if (result.errors) {
          console.error('GraphQL errors:', result.errors);
          throw new Error('Failed to fetch product data');
        }

        const product = result.data.product;
        console.log(`ðŸ“‹ Metafields for ${handle}:`, product.metafields);

        // Parse metafields with better error handling
        const metafields = {};
        const specs = {};
        
        product.metafields.forEach(mf => {
          if (!mf) {
            console.warn(`Null metafield encountered for ${handle}`);
            return;
          }
          
          console.log(`  Processing metafield: ${mf.key} = ${mf.value} (type: ${typeof mf.value})`);
          
          if (mf.key === 'specifications' && mf.reference?.fields) {
            // Parse specifications metaobject
            console.log(`  ðŸ“Š Specifications metaobject fields:`, mf.reference.fields);
            mf.reference.fields.forEach(field => {
              specs[field.key] = field.value;
            });
          } else if (mf.key === 'has_cpr_feedback' || mf.key === 'has_wifi_monitoring' || mf.key === 'has_pediatric_mode') {
            // Handle boolean - could be string "true", boolean true, or null
            metafields[mf.key] = parseBoolean(mf.value);
            console.log(`  âœ“ Boolean parsed: ${mf.key} = ${metafields[mf.key]}`);
          } else if (mf.key === 'warranty_years' || mf.key === 'battery_life_years' || mf.key === 'pad_life_years') {
            metafields[mf.key] = mf.value ? parseInt(mf.value) : null;
          } else {
            metafields[mf.key] = mf.value;
          }
        });

        console.log(`âœ… Final parsed data for ${handle}:`, { metafields, specs });

        // Transform to our format
        return {
          handle: product.handle,
          id: product.id,
          title: product.title,
          price: parseFloat(product.priceRange.minVariantPrice.amount) * 100,
          compare_at_price: product.compareAtPriceRange?.minVariantPrice?.amount ? parseFloat(product.compareAtPriceRange.minVariantPrice.amount) * 100 : null,
          manufacturer: metafields.manufacturer || product.vendor,
          vendor: product.vendor,
          type: product.productType,
          image: product.featuredImage?.url,
          url: `/products/${product.handle}`,
          available: product.availableForSale,
          variantId: product.variants.nodes[0]?.id,
          description: product.description?.replace(/<[^>]*>/g, '').substring(0, 150) + '...',
          
          // Metafields
          shock_type: metafields.shock_type,
          has_cpr_feedback: metafields.has_cpr_feedback,
          has_wifi_monitoring: metafields.has_wifi_monitoring,
          has_pediatric_mode: metafields.has_pediatric_mode,
          warranty_years: metafields.warranty_years,
          battery_life_years: metafields.battery_life_years,
          pad_life_years: metafields.pad_life_years,
          
          // Specifications
          weight: specs.weight,
          dimensions: specs.dimensions,
          ip_rating: specs.ip_rating,
          shock_delivery_type: specs.shock_delivery_type,
          cpr_feedback: specs.cpr_feedback,
          pediatric_capability: specs.pediatric_capability,
          connectivity: specs.connectivity
        };
      } catch (err) {
        console.error(`âŒ Error fetching product ${handle}:`, err);
        throw err;
      }
    }

    window.addToCompare = async function(handle) {
      const list = getCompareList();
      if (list.find(p => p.handle === handle)) {
        window.removeFromCompare(handle);
        return;
      }
      if (list.length >= MAX_COMPARE) {
        alert(`Maximum ${MAX_COMPARE} products can be compared`);
        return;
      }

      try {
        const product = await fetchProductWithMetafields(handle);
        list.push(product);
        saveCompareList(list);
        updateCompareUI();
        updateCompareButtons();
      } catch (err) {
        console.error('Error adding to compare:', err);
        alert('Error adding product to comparison');
      }
    };

    window.removeFromCompare = function(handle) {
      let list = getCompareList();
      list = list.filter(p => p.handle !== handle);
      saveCompareList(list);
      updateCompareUI();
      updateCompareButtons();
    };

    window.isInCompare = function(handle) {
      return getCompareList().some(p => p.handle === handle);
    };

    function updateCompareButtons() {
      document.querySelectorAll('[data-compare-add]').forEach(btn => {
        const handle = btn.dataset.compareAdd;
        const isInList = window.isInCompare(handle);
        btn.classList.toggle('is-active', isInList);
        btn.setAttribute('aria-pressed', isInList);
        const textEl = btn.querySelector('.compare-btn__text');
        if (textEl) textEl.textContent = isInList ? 'Remove' : 'Compare';
      });
    }

    function updateCompareUI() {
      const list = getCompareList();

      if (compareCount) {
        compareCount.textContent = list.length;
      }

      if (compareBar) {
        compareBar.hidden = list.length === 0;
      }

      if (compareBarProducts) {
        compareBarProducts.innerHTML = list.map(p => `
          <div class="compare-bar__product">
            <img src="${p.image}" alt="${p.title}" width="40" height="40">
            <button type="button" class="compare-bar__remove" onclick="removeFromCompare('${p.handle}')" aria-label="Remove ${p.title}">Ã—</button>
          </div>
        `).join('');
      }

      if (compareTable && compareEmpty && compareBody) {
        if (list.length < 2) {
          compareTable.hidden = true;
          compareEmpty.hidden = false;
          return;
        }

        compareTable.hidden = false;
        compareEmpty.hidden = true;

        const thead = compareTable.querySelector('thead tr');
        thead.innerHTML = '<th scope="col" class="product-compare__feature-header">Feature</th>';
        list.forEach(p => {
          thead.innerHTML += `
            <th scope="col" class="product-compare__product-header">
              <button type="button" class="product-compare__remove" onclick="removeFromCompare('${p.handle}')" aria-label="Remove ${p.title}">Ã—</button>
              <a href="${p.url}">
                <img src="${p.image}" alt="${p.title}" width="120" height="120">
              </a>
              <a href="${p.url}" class="product-compare__product-title">${p.title}</a>
            </th>
          `;
        });

        compareBody.innerHTML = '';

        compareFeatures.forEach(featureGroup => {
          const sectionRow = document.createElement('tr');
          sectionRow.className = 'product-compare__section-header';
          sectionRow.innerHTML = `<th colspan="${list.length + 1}" style="background:#f5f5f5;padding:12px 20px;font-weight:700;color:#8b1538;">${featureGroup.section}</th>`;
          compareBody.appendChild(sectionRow);

          featureGroup.rows.forEach(feature => {
            const row = document.createElement('tr');
            row.innerHTML = `<th scope="row">${feature.label}</th>` + list.map(p => {
              let value = p[feature.key];

              if (feature.format) {
                if (feature.format === 'money') {
                  value = window.Shopify?.formatMoney ? window.Shopify.formatMoney(value, window.theme?.moneyFormat || '${{amount}}') : '$' + (value / 100).toFixed(2);
                  if (p.compare_at_price && p.compare_at_price > p.price) {
                    const compare = window.Shopify?.formatMoney ? window.Shopify.formatMoney(p.compare_at_price, window.theme?.moneyFormat || '${{amount}}') : '$' + (p.compare_at_price / 100).toFixed(2);
                    value = `<strong>${value}</strong><br><span style="text-decoration:line-through;color:#999;font-size:0.9em">${compare}</span>`;
                  } else {
                    value = `<strong>${value}</strong>`;
                  }
                } else {
                  value = feature.format(value);
                }
              }

              return `<td>${value !== null && value !== undefined ? value : '-'}</td>`;
            }).join('');
            compareBody.appendChild(row);
          });
        });

        const tfoot = compareTable.querySelector('tfoot tr');
        tfoot.innerHTML = '<td></td>' + list.map(p => `
          <td>
            ${p.available
              ? `<a href="${p.url}" class="btn btn--primary btn--small btn--full">View Product</a>`
              : '<button class="btn btn--outline btn--small btn--full" disabled>Sold Out</button>'
            }
          </td>
        `).join('');
      }
    }

    document.querySelector('[data-compare-clear]')?.addEventListener('click', () => {
      if (confirm('Clear all products from comparison?')) {
        saveCompareList([]);
        updateCompareUI();
        updateCompareButtons();
      }
    });

    document.querySelector('[data-compare-print]')?.addEventListener('click', () => {
      window.print();
    });

    updateCompareUI();
    updateCompareButtons();
    document.addEventListener('compare:updated', updateCompareButtons);
  })();
</script>

{% schema %}
{
  "name": "Product Compare",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Compare Products"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum products to compare",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4
    }
  ],
  "presets": [
    {
      "name": "Product Compare"
    }
  ]
}
{% endschema %}

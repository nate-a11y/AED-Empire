{% comment %}
  Image Hotspots / Shoppable Image
  Premium feature - clickable hotspots on images that link to products
  Perfect for "shop the look" or equipment diagrams
{% endcomment %}

<section class="image-hotspots section {% if section.settings.full_width %}image-hotspots--full{% endif %}" aria-labelledby="hotspots-heading">
  {% unless section.settings.full_width %}<div class="container">{% endunless %}
    {% if section.settings.title != blank %}
      <div class="section-header">
        <h2 id="hotspots-heading">{{ section.settings.title }}</h2>
        {% if section.settings.subtitle %}
          <p>{{ section.settings.subtitle }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="image-hotspots__container">
      <div class="image-hotspots__image-wrapper">
        {% if section.settings.image %}
          <img
            src="{{ section.settings.image | image_url: width: 1600 }}"
            alt="{{ section.settings.image.alt | default: section.settings.title | escape }}"
            width="1600"
            height="{{ 1600 | divided_by: section.settings.image.aspect_ratio | round }}"
            loading="lazy"
          >
        {% else %}
          <div class="image-hotspots__placeholder">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" aria-hidden="true">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <p>Add an image with hotspots</p>
          </div>
        {% endif %}

        {% for block in section.blocks %}
          {% if block.type == 'hotspot' %}
            <button
              type="button"
              class="image-hotspots__dot"
              style="left: {{ block.settings.position_x }}%; top: {{ block.settings.position_y }}%;"
              data-hotspot="{{ forloop.index }}"
              aria-label="View {{ block.settings.product.title | default: 'product' }}"
              aria-expanded="false"
              {{ block.shopify_attributes }}
            >
              <span class="image-hotspots__pulse"></span>
              <span class="image-hotspots__dot-inner">
                {% if block.settings.icon == 'plus' %}+{% else %}{{ forloop.index }}{% endif %}
              </span>
            </button>

            <div class="image-hotspots__popup" data-hotspot-popup="{{ forloop.index }}" hidden>
              {% if block.settings.product != blank %}
                {% assign hotspot_product = block.settings.product %}
                <a href="{{ hotspot_product.url }}" class="image-hotspots__popup-inner">
                  {% if hotspot_product.featured_image %}
                    <img
                      src="{{ hotspot_product.featured_image | image_url: width: 200 }}"
                      alt="{{ hotspot_product.title | escape }}"
                      width="80"
                      height="80"
                      loading="lazy"
                    >
                  {% endif %}
                  <div class="image-hotspots__popup-info">
                    <h4>{{ hotspot_product.title }}</h4>
                    <p class="image-hotspots__popup-price">{{ hotspot_product.price | money }}</p>
                  </div>
                </a>
              {% else %}
                <div class="image-hotspots__popup-inner">
                  <div class="image-hotspots__popup-info">
                    <h4>{{ block.settings.custom_title | default: 'Product' }}</h4>
                    {% if block.settings.custom_text %}
                      <p>{{ block.settings.custom_text }}</p>
                    {% endif %}
                    {% if block.settings.custom_link %}
                      <a href="{{ block.settings.custom_link }}" class="image-hotspots__popup-link">Learn More</a>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
              <button type="button" class="image-hotspots__popup-close" data-hotspot-close aria-label="Close">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% unless section.settings.full_width %}</div>{% endunless %}
</section>

<style>
  .image-hotspots__container {
    position: relative;
  }
  .image-hotspots--full .image-hotspots__container {
    max-width: 100%;
  }
  .image-hotspots__image-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
  }
  .image-hotspots__image-wrapper img {
    width: 100%;
    height: auto;
    display: block;
  }
  .image-hotspots__placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    background: var(--color-bg-alt);
    border-radius: var(--card-radius);
    color: var(--color-text-light);
    text-align: center;
    gap: 15px;
  }
  .image-hotspots__dot {
    position: absolute;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: var(--color-primary);
    border: 3px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    transition: transform 0.2s;
  }
  .image-hotspots__dot:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }
  .image-hotspots__dot:focus {
    outline: none;
    box-shadow: 0 0 0 4px rgba(var(--color-primary-rgb), 0.4), 0 2px 10px rgba(0,0,0,0.3);
  }
  .image-hotspots__dot-inner {
    color: #fff;
    font-weight: 700;
    font-size: 0.875rem;
  }
  .image-hotspots__pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--color-primary);
    opacity: 0.4;
    animation: hotspotPulse 2s infinite;
  }
  @keyframes hotspotPulse {
    0% { transform: scale(1); opacity: 0.4; }
    100% { transform: scale(2); opacity: 0; }
  }
  .image-hotspots__popup {
    position: absolute;
    z-index: 10;
    background: var(--color-bg);
    border-radius: var(--card-radius);
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    min-width: 250px;
    animation: hotspotPopup 0.2s ease;
  }
  @keyframes hotspotPopup {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .image-hotspots__popup-inner {
    display: flex;
    gap: 15px;
    padding: 15px;
    text-decoration: none;
    color: inherit;
  }
  .image-hotspots__popup-inner img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
  }
  .image-hotspots__popup-info {
    flex: 1;
  }
  .image-hotspots__popup-info h4 {
    margin: 0 0 5px;
    font-size: 0.9375rem;
  }
  .image-hotspots__popup-price {
    color: var(--color-primary);
    font-weight: 700;
    margin: 0;
  }
  .image-hotspots__popup-link {
    font-size: 0.8125rem;
    font-weight: 500;
  }
  .image-hotspots__popup-close {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--color-text-light);
    cursor: pointer;
  }
  .image-hotspots__popup-close:hover {
    color: var(--color-text);
  }
</style>

<script>
  (function() {
    const container = document.querySelector('.image-hotspots__image-wrapper');
    if (!container) return;

    let activePopup = null;

    // Position popup near hotspot
    function positionPopup(dot, popup) {
      const dotRect = dot.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();

      const dotX = ((dotRect.left - containerRect.left) / containerRect.width) * 100;
      const dotY = ((dotRect.top - containerRect.top) / containerRect.height) * 100;

      // Position to the right by default, left if too close to edge
      if (dotX > 60) {
        popup.style.right = `${100 - dotX + 3}%`;
        popup.style.left = 'auto';
      } else {
        popup.style.left = `${dotX + 3}%`;
        popup.style.right = 'auto';
      }

      // Vertical position
      if (dotY > 70) {
        popup.style.bottom = `${100 - dotY + 3}%`;
        popup.style.top = 'auto';
      } else {
        popup.style.top = `${dotY}%`;
        popup.style.bottom = 'auto';
      }
    }

    // Toggle popup
    document.querySelectorAll('[data-hotspot]').forEach(dot => {
      dot.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = dot.dataset.hotspot;
        const popup = document.querySelector(`[data-hotspot-popup="${index}"]`);

        // Close any open popup
        if (activePopup && activePopup !== popup) {
          activePopup.hidden = true;
          document.querySelector(`[data-hotspot="${activePopup.dataset.hotspotPopup}"]`)?.setAttribute('aria-expanded', 'false');
        }

        if (popup.hidden) {
          popup.hidden = false;
          positionPopup(dot, popup);
          dot.setAttribute('aria-expanded', 'true');
          activePopup = popup;
        } else {
          popup.hidden = true;
          dot.setAttribute('aria-expanded', 'false');
          activePopup = null;
        }
      });
    });

    // Close button
    document.querySelectorAll('[data-hotspot-close]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const popup = btn.closest('[data-hotspot-popup]');
        popup.hidden = true;
        document.querySelector(`[data-hotspot="${popup.dataset.hotspotPopup}"]`)?.setAttribute('aria-expanded', 'false');
        activePopup = null;
      });
    });

    // Close on outside click
    document.addEventListener('click', () => {
      if (activePopup) {
        activePopup.hidden = true;
        document.querySelector(`[data-hotspot="${activePopup.dataset.hotspotPopup}"]`)?.setAttribute('aria-expanded', 'false');
        activePopup = null;
      }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && activePopup) {
        activePopup.hidden = true;
        document.querySelector(`[data-hotspot="${activePopup.dataset.hotspotPopup}"]`)?.focus();
        activePopup = null;
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Image Hotspots",
  "tag": "section",
  "class": "section-image-hotspots",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Shop the Look"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": false
    }
  ],
  "blocks": [
    {
      "type": "hotspot",
      "name": "Hotspot",
      "limit": 10,
      "settings": [
        {
          "type": "range",
          "id": "position_x",
          "label": "Horizontal position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "position_y",
          "label": "Vertical position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon style",
          "options": [
            { "value": "number", "label": "Number" },
            { "value": "plus", "label": "Plus sign" }
          ],
          "default": "plus"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "header",
          "content": "Custom content (if no product)"
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Title"
        },
        {
          "type": "text",
          "id": "custom_text",
          "label": "Text"
        },
        {
          "type": "url",
          "id": "custom_link",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image Hotspots",
      "blocks": [
        { "type": "hotspot", "settings": { "position_x": 30, "position_y": 40 } },
        { "type": "hotspot", "settings": { "position_x": 70, "position_y": 60 } }
      ]
    }
  ]
}
{% endschema %}
